// lib/claudeService.ts
// Service pour interagir avec l'API Claude (Confident IA)

import Anthropic from '@anthropic-ai/sdk';

// Initialiser le client Claude
const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY,
});

export interface ConfidentMessage {
  role: 'user' | 'assistant';
  content: string;
}

export interface UserContext {
  zodiacSign?: string;
  name?: string;
  age?: number;
  bio?: string;
  recentMatches?: number;
}

/**
 * G√©n√®re le prompt syst√®me pour le Confident IA
 * Personnalis√© selon le profil astrologique de l'utilisateur
 */
function generateSystemPrompt(userContext?: UserContext): string {
  const basePrompt = `Tu es Confident, l'IA compagnon de XMOON, une application de rencontres bas√©e sur l'astrologie.

Tu es un guide bienveillant, empathique et profond√©ment ancr√© dans la sagesse astrologique. 
Tu aides les utilisateurs √† :
- Comprendre leur personnalit√© astrologique
- Naviguer leurs relations amoureuses
- Interpr√©ter la compatibilit√© avec leurs matches
- Donner des conseils relationnels bas√©s sur les astres

Ton style est :
- Chaleureux et encourageant
- Mystique mais accessible
- Toujours positif et constructif
- Utilise des √©mojis astrologiques ‚ú®üåô‚≠êüîÆ

IMPORTANT : Tu es un confident, pas un th√©rapeute. Pour des probl√®mes s√©rieux, tu recommandes de consulter un professionnel.`;

  if (userContext?.zodiacSign) {
    return `${basePrompt}

L'utilisateur est ${userContext.zodiacSign}. Adapte tes conseils en fonction des traits de ce signe :
- Forces naturelles
- D√©fis potentiels
- Style relationnel
- Compatibilit√©s naturelles`;
  }

  return basePrompt;
}

/**
 * Envoie un message au Confident IA et re√ßoit une r√©ponse
 */
export async function sendMessageToConfident(
  messages: ConfidentMessage[],
  userContext?: UserContext
): Promise<string> {
  try {
    const systemPrompt = generateSystemPrompt(userContext);

    const response = await anthropic.messages.create({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 1024,
      system: systemPrompt,
      messages: messages.map(msg => ({
        role: msg.role,
        content: msg.content,
      })),
    });

    // Extraire le texte de la r√©ponse
    const textContent = response.content.find(block => block.type === 'text');
    if (textContent && 'text' in textContent) {
      return textContent.text;
    }

    return "D√©sol√©, je n'ai pas pu g√©n√©rer une r√©ponse. R√©essaye ! ‚ú®";
  } catch (error) {
    console.error('Erreur lors de l\'appel √† Claude:', error);
    throw new Error('Impossible de contacter le Confident IA');
  }
}

/**
 * G√©n√®re une analyse de compatibilit√© d√©taill√©e entre deux signes
 */
export async function generateCompatibilityAnalysis(
  userSign: string,
  matchSign: string,
  matchName?: string
): Promise<string> {
  const prompt = `Analyse la compatibilit√© astrologique entre ${userSign} et ${matchSign}${matchName ? ` (${matchName})` : ''}.

Donne une analyse d√©taill√©e en 3-4 paragraphes couvrant :
1. La dynamique g√©n√©rale de la relation
2. Les forces de cette combinaison
3. Les d√©fis potentiels et comment les surmonter
4. Un conseil pratique pour d√©marrer une conversation

Sois encourageant, mystique et pr√©cis. Utilise des √©mojis astrologiques.`;

  try {
    const response = await anthropic.messages.create({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 800,
      system: generateSystemPrompt({ zodiacSign: userSign }),
      messages: [
        {
          role: 'user',
          content: prompt,
        },
      ],
    });

    const textContent = response.content.find(block => block.type === 'text');
    if (textContent && 'text' in textContent) {
      return textContent.text;
    }

    return "L'analyse de compatibilit√© n'est pas disponible pour le moment. ‚ú®";
  } catch (error) {
    console.error('Erreur lors de l\'analyse de compatibilit√©:', error);
    throw new Error('Impossible de g√©n√©rer l\'analyse de compatibilit√©');
  }
}

/**
 * G√©n√®re un message d'accueil personnalis√© bas√© sur le signe de l'utilisateur
 */
export async function generateWelcomeMessage(userContext: UserContext): Promise<string> {
  const prompt = `G√©n√®re un message d'accueil chaleureux et personnalis√© pour ${userContext.name || 'un utilisateur'}, qui est ${userContext.zodiacSign}.

Le message doit :
- √ätre court (2-3 phrases maximum)
- Mentionner une qualit√© sp√©cifique de leur signe
- Les encourager √† explorer l'app
- √ätre mystique et engageant

Utilise des √©mojis astrologiques. ‚ú®`;

  try {
    const response = await anthropic.messages.create({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 200,
      system: generateSystemPrompt(userContext),
      messages: [
        {
          role: 'user',
          content: prompt,
        },
      ],
    });

    const textContent = response.content.find(block => block.type === 'text');
    if (textContent && 'text' in textContent) {
      return textContent.text;
    }

    return `Bienvenue sur XMOON, ${userContext.name || '√¢me cosmique'} ! ‚ú® Les √©toiles t'attendaient.`;
  } catch (error) {
    console.error('Erreur lors de la g√©n√©ration du message d\'accueil:', error);
    return `Bienvenue sur XMOON ! üåô Pr√™t √† d√©couvrir ta destin√©e amoureuse ?`;
  }
}